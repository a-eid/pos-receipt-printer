name: build-and-release-prebuilts
on:
  push:
    tags:
      - 'v*' # trigger for v0.1.0 and pre-releases like v0.1.0-rc.1
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64
          - os: windows-latest
            artifact_name: pos-receipt-printer-win32-x64.node
          # macOS Apple Silicon
          - os: macos-latest
            artifact_name: pos-receipt-printer-darwin-arm64.node
          # macOS Intel
          - os: macos-13
            artifact_name: pos-receipt-printer-darwin-x64.node
          # Linux x64 (glibc)
          - os: ubuntu-latest
            artifact_name: pos-receipt-printer-linux-x64-gnu.node
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: dtolnay/rust-toolchain@stable
      - name: Install @napi-rs/cli
        run: npm i -g @napi-rs/cli
      - name: Install JS deps (skip scripts)
        run: npm ci --ignore-scripts
      - name: Build native module (release)
        run: napi build --release
      - name: Debug refs
        run: |
          echo "GITHUB_REF: $GITHUB_REF"
          echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
          node -v
          rustc -V
      - name: Rename artifact to expected name
        env:
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
        run: |
          node -e "const fs=require('fs');const f=fs.readdirSync('.').find(n=>n.endsWith('.node'));if(!f){console.error('No .node found in project root');process.exit(1);}fs.copyFileSync(f, process.env.ARTIFACT_NAME);console.log('Copied', f, '->', process.env.ARTIFACT_NAME);"
      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ matrix.artifact_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
